{% extends 'recipe_base.html' %}
{% load static %}

{% block title %}智能菜谱推荐 - 饭了么{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'fruit/recipe.css' %}">
<style>
.ingredient-match{color:#007bff;font-weight:600;}
.ingredient-extra{color:#dc3545;font-weight:600;}
.combo-parts{display:flex;gap:12px;margin-top:8px;}
.combo-part{flex:1;border-top:1px solid #eee;padding-top:6px;}
</style>
{% endblock %}

{% block content %}
<div class="container">
    <!-- 头部导航 -->
    <header class="header">
        <div class="nav-container">
            <div class="logo">
                <i class="fas fa-carrot"></i> 饭了么
            </div>
            
            <div class="nav-links">
                <a href="{% url 'recipe_view' %}" style="color: var(--primary-color);">食谱</a>
                <a href="{% url 'product_list' %}">商城</a>
                <a href="{% url 'fridge_view' %}">冰箱</a>
                <a href="{% url 'my_view' %}">我的</a>
                {% if user.is_authenticated %}
                <a href="{% url 'logout_view' %}"><i class="fas fa-sign-out-alt"></i> 退出</a>
                {% endif %}
            </div>
            
            <div class="search-container">
                <input type="text" placeholder="搜索菜谱...">
                <button><i class="fas fa-search"></i></button>
            </div>
        </div>
    </header>
    
    <!-- 菜谱推荐区域 -->
    <div class="section-title">
        <h2><i class="fas fa-utensils"></i> 智能菜谱推荐</h2>
    </div>
    
    <div class="input-section">
        <div class="input-header">
            <i class="fas fa-carrot"></i>
            <h3>我有这些食材...</h3>
        </div>
        
        <p class="input-subtitle">请输入您现有的食材（1-5种），我们将为您推荐合适的菜谱</p>
        
        <form id="recipe-form">
            {% csrf_token %}
            <div class="ingredient-inputs">
                <div class="ingredient-box">
                    <label for="ingredient1">食材 1</label>
                    <input type="text" id="ingredient1" name="ingredient1" placeholder="例如：鸡蛋">
                </div>
                
                <div class="ingredient-box">
                    <label for="ingredient2">食材 2</label>
                    <input type="text" id="ingredient2" name="ingredient2" placeholder="例如：番茄">
                </div>
                
                <div class="ingredient-box">
                    <label for="ingredient3">食材 3</label>
                    <input type="text" id="ingredient3" name="ingredient3" placeholder="例如：青椒">
                </div>
                
                <div class="ingredient-box">
                    <label for="ingredient4">食材 4</label>
                    <input type="text" id="ingredient4" name="ingredient4" placeholder="例如：洋葱">
                </div>
                
                <div class="ingredient-box">
                    <label for="ingredient5">食材 5</label>
                    <input type="text" id="ingredient5" name="ingredient5" placeholder="例如：鸡肉">
                </div>
            </div>
            
            <div class="actions">
                <button type="button" class="btn btn-primary" id="find-recipes">
                    <i class="fas fa-search"></i> 推荐菜谱
                </button>
                
                <button type="button" class="btn btn-outline" id="reset-inputs">
                    <i class="fas fa-redo"></i> 重新输入
                </button>
            </div>
            
            <div class="filter-option">
                <input type="checkbox" id="filter-recipes">
                <label for="filter-recipes">仅显示无需额外采购的菜谱</label>
            </div>
        </form>
    </div>
    
    <div class="recipes-grid" id="recipes-container">
        <!-- 示例卡片将由JavaScript动态生成 -->
    </div>
    
    <!-- 猜你喜欢区域 -->
    <div class="section-title" style="display:flex; align-items:center; gap:20px;">
        <h2 style="margin:0;"><i class="fas fa-heart"></i> 猜你喜欢</h2>
        <button type="button" class="btn btn-secondary" id="healthy-recommend-btn" style="padding:6px 12px; font-size:14px;">
            <i class="fas fa-leaf"></i> 健康饮食推荐
        </button>
    </div>
    <!-- 健康推荐结果容器 -->
    <div class="recipes-grid" id="healthy-container"></div>

    <div class="recipes-grid">
        {% for recipe in popular_recipes %}
        <div class="recipe-card" data-extra="false">
            <div class="recipe-image">
                <img src="{{ recipe.image_url }}" alt="{{ recipe.title }}">
                <div class="recipe-match">热门</div>
            </div>
            
            <div class="recipe-info">
                <h3 class="recipe-title">{{ recipe.title }}</h3>
                
                <div class="recipe-meta">
                    <div class="meta-item">
                        <i class="fas fa-clock"></i>
                        <span>{{ recipe.cook_time }}</span>
                    </div>
                    
                    <div class="meta-item">
                        <i class="fas fa-tachometer-alt"></i>
                        <span>{{ recipe.difficulty }}</span>
                    </div>
                </div>
                
                <div class="ingredients-title">
                    <i class="fas fa-apple-alt"></i>
                    <span>所需食材：</span>
                </div>
                
                <ul class="ingredients-list">
                    {% for ingredient in recipe.ingredients %}
                    <li>{{ ingredient.name }} {{ ingredient.amount }}</li>
                    {% endfor %}
                </ul>
                
                <div class="recipe-actions">
                    <a href="{% url 'recipe_detail' recipe.id %}" class="view-recipe-btn">
                        <i class="fas fa-book-open"></i> 查看做法
                    </a>
                </div>
            </div>
        </div>
        {% endfor %}
        
        {% for recipe in healthy_recipes %}
        <div class="recipe-card" data-extra="false">
            <div class="recipe-image">
                <img src="{{ recipe.image_url }}" alt="{{ recipe.title }}">
                <div class="recipe-match">健康</div>
            </div>
            
            <div class="recipe-info">
                <h3 class="recipe-title">{{ recipe.title }}</h3>
                
                <div class="recipe-meta">
                    <div class="meta-item">
                        <i class="fas fa-clock"></i>
                        <span>{{ recipe.cook_time }}</span>
                    </div>
                    
                    <div class="meta-item">
                        <i class="fas fa-tachometer-alt"></i>
                        <span>{{ recipe.difficulty }}</span>
                    </div>
                </div>
                
                <div class="ingredients-title">
                    <i class="fas fa-apple-alt"></i>
                    <span>所需食材：</span>
                </div>
                
                <ul class="ingredients-list">
                    {% for ingredient in recipe.ingredients %}
                    <li>{{ ingredient.name }} {{ ingredient.amount }}</li>
                    {% endfor %}
                </ul>
                
                <div class="recipe-actions">
                    <a href="{% url 'recipe_detail' recipe.id %}" class="view-recipe-btn">
                        <i class="fas fa-book-open"></i> 查看做法
                    </a>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<!-- 菜谱卡片模板 -->
<template id="recipe-card-template">
    <div class="recipe-card">
        <div class="recipe-image">
            <img src="" alt="">
            <div class="recipe-match"></div>
        </div>
        
        <div class="recipe-info">
            <h3 class="recipe-title"></h3>
            
            <div class="recipe-meta">
                <div class="meta-item">
                    <i class="fas fa-clock"></i>
                    <span></span>
                </div>
                
                <div class="meta-item">
                    <i class="fas fa-tachometer-alt"></i>
                    <span></span>
                </div>
            </div>
            
            <div class="ingredients-title">
                <i class="fas fa-apple-alt"></i>
                <span>所需食材：</span>
            </div>
            
            <ul class="ingredients-list"></ul>
            
            <div class="recipe-actions">
                <a class="view-recipe-btn">
                    <i class="fas fa-book-open"></i> 查看做法
                </a>
            </div>
        </div>
    </div>
</template>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // 获取表单和按钮元素
        const recipeForm = document.getElementById('recipe-form');
        const findRecipesButton = document.getElementById('find-recipes');
        const resetButton = document.getElementById('reset-inputs');
        const filterCheckbox = document.getElementById('filter-recipes');
        const recipesContainer = document.getElementById('recipes-container');
        const recipeCardTemplate = document.getElementById('recipe-card-template');
        
        // 重置输入按钮功能
        if (resetButton) {
            resetButton.addEventListener('click', function() {
                const inputs = document.querySelectorAll('.ingredient-box input');
                inputs.forEach(input => {
                    input.value = '';
                });
            });
        }
        
        // 推荐菜谱按钮功能
        if (findRecipesButton) {
            findRecipesButton.addEventListener('click', function() {
                const formData = new FormData(recipeForm);
                const ingredients = [];
                
                // 收集非空食材
                for (let i = 1; i <= 5; i++) {
                    const ingredientValue = formData.get(`ingredient${i}`).trim();
                    if (ingredientValue) {
                        ingredients.push(ingredientValue);
                    }
                }
                
                if (ingredients.length === 0) {
                    alert('请输入至少一种食材');
                    return;
                }
                
                // 发送AJAX请求获取推荐菜谱
                fetch('{% url "recommend_recipes" %}', {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                        'X-CSRFToken': formData.get('csrfmiddlewaretoken')
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // 清空容器
                        recipesContainer.innerHTML = '';
                        
                        // 添加菜谱卡片
                        data.recipes.forEach(recipe => {
                            const card = createRecipeCard(recipe);
                            recipesContainer.appendChild(card);
                        });
                        
                        // 应用过滤器
                        if (filterCheckbox.checked) {
                            filterRecipes();
                        }
                    } else {
                        alert(data.message || '获取菜谱失败，请稍后再试');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('发生错误，请稍后再试');
                });
            });
        }
        
        // 过滤菜谱功能
        if (filterCheckbox) {
            filterCheckbox.addEventListener('change', filterRecipes);
        }
        
        // 健康饮食推荐按钮
        const healthyBtn = document.getElementById('healthy-recommend-btn');
        const healthyContainer = document.getElementById('healthy-container');
        if (healthyBtn) {
            healthyBtn.addEventListener('click', function () {
                // 发起后端健康推荐请求（无需前端拼装食材）
                fetch("{% url 'healthy_recommend' %}", {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': document.querySelector('input[name=\"csrfmiddlewaretoken\"]').value
                    },
                    body: JSON.stringify({})
                }).then(r => r.json()).then(data => {
                    healthyContainer.innerHTML = '';
                    let combos = Array.isArray(data.combos) ? data.combos : null;
                    if (combos && combos.length) {
                        combos.forEach(cb => healthyContainer.appendChild(createComboCard(cb)));
                    } else {
                        const list = Array.isArray(data.recipes) ? data.recipes : (data.dish_name ? [data] : []);
                        if (!list.length) {
                            alert('暂无健康推荐结果');
                            return;
                        }
                        list.forEach(rcp => healthyContainer.appendChild(createRecipeCard(rcp)));
                    }
                    healthyContainer.scrollIntoView({ behavior: 'smooth' });
                }).catch(err => {
                    console.error(err);
                    alert('健康推荐失败，请稍后再试');
                });
            });
        }

        // 过滤菜谱函数
        function filterRecipes() {
            const recipeCards = document.querySelectorAll('#recipes-container .recipe-card');
            recipeCards.forEach(card => {
                if (filterCheckbox.checked && card.dataset.extra === 'true') {
                    card.style.display = 'none';
                } else {
                    card.style.display = 'block';
                }
            });
        }
        
        // 创建菜谱卡片函数
        function createRecipeCard(recipe) {
            const template = recipeCardTemplate.content.cloneNode(true);
            const card = template.querySelector('.recipe-card');
            
            // 设置数据属性（兼容无 needs_extra 字段的情况）
            const needsExtra = recipe.needs_extra !== undefined ? recipe.needs_extra : false;
            card.dataset.extra = needsExtra.toString();
            
            // 设置图片和标题
            const img = card.querySelector('.recipe-image img');
            img.src = recipe.image_url || recipe.image_path || '';
            img.alt = recipe.title || recipe.dish_name || '';
            
            // 设置匹配度
            const matchDiv = card.querySelector('.recipe-match');
            const matchVal = recipe.match_percentage !== undefined ? `${recipe.match_percentage}% 匹配` : (recipe.score !== undefined ? `${Math.round(recipe.score*100)}% 推荐` : '');
            matchDiv.textContent = matchVal;
            
            // 设置标题
            card.querySelector('.recipe-title').textContent = recipe.title || recipe.dish_name || '';
            
            // 设置烹饪时间和难度
            const metaItems = card.querySelectorAll('.meta-item span');
            metaItems[0].textContent = recipe.cooking_time ? `${recipe.cooking_time}分钟` : (recipe.cook_time || '');
            metaItems[1].textContent = recipe.difficulty || '';
            
            // 添加食材
            const ingredientsList = card.querySelector('.ingredients-list');
            (recipe.ingredients || []).forEach(ingredient => {
                const li = document.createElement('li');
                
                if (ingredient.is_match) {
                    const span = document.createElement('span');
                    span.className = 'ingredient-match';
                    span.textContent = ingredient.name;
                    li.appendChild(span);
                    li.appendChild(document.createTextNode(` ${ingredient.amount}`));
                } else {
                    if (recipe.needs_extra) {
                        const span = document.createElement('span');
                        span.className = 'ingredient-extra';
                        span.textContent = ingredient.name;
                        li.appendChild(span);
                        li.appendChild(document.createTextNode(` ${ingredient.amount}`));
                    } else {
                        li.textContent = `${ingredient.name} ${ingredient.amount}`;
                    }
                }
                
                ingredientsList.appendChild(li);
            });
            
            // 设置详情链接，根据是否 AI 菜谱切换 URL
            const viewButton = card.querySelector('.view-recipe-btn');
            const isAI = recipe.match_percentage === 'AI' || (recipe.title && recipe.title.includes('AI生成'));
            viewButton.href = isAI ? `/ai_recipe/${recipe.id}/` : `/recipe/${recipe.id}/`;
            
            return card;
}

// 创建组合菜谱卡片：一菜一汤 / 一菜一凉菜
function createComboCard(combo) {
    const { main, side, total_calories } = combo;
    const card = document.createElement('div');
    card.className = 'recipe-card combo-card';

    // 图片：优先主菜
    const imgWrap = document.createElement('div');
    imgWrap.className = 'recipe-image';
    const img = document.createElement('img');
    img.src = main.image_url || side.image_url || '';
    img.alt = `${main.title} + ${side.title}`;
    imgWrap.appendChild(img);
    card.appendChild(imgWrap);

    // 信息区域
    const info = document.createElement('div');
    info.className = 'recipe-info';

    // 标题
    const h3 = document.createElement('h3');
    h3.className = 'recipe-title';
    h3.textContent = `${main.title} + ${side.title}`;
    info.appendChild(h3);

    // 元信息：热量
    const meta = document.createElement('div');
    meta.className = 'recipe-meta';
    meta.innerHTML = `<div class="meta-item"><i class="fas fa-fire"></i><span>${total_calories} kcal</span></div>`;
    info.appendChild(meta);

    // 两道菜食材分别展示
    const buildPart = (part) => {
        const partDiv = document.createElement('div');
        partDiv.className = 'combo-part';

        const ingList = document.createElement('ul');
        ingList.className = 'ingredients-list';
        (part.ingredients || []).forEach(ing => {
            const li = document.createElement('li');
            if (ing.is_match === false) {
                li.innerHTML = `<span class="ingredient-extra">${ing.name}</span> ${ing.amount || ''}`;
            } else if (ing.is_match) {
                li.innerHTML = `<span class="ingredient-match">${ing.name}</span> ${ing.amount || ''}`;
            } else {
                li.textContent = `${ing.name} ${ing.amount || ''}`;
            }
            ingList.appendChild(li);
        });

        const link = document.createElement('a');
        link.className = 'view-recipe-btn';
        if (part.id) {
            const isAI = part.is_ai || (part.title && part.title.includes('AI生成'));
            link.href = isAI ? `/ai_recipe/${part.id}/` : `/recipe/${part.id}/`;
            link.innerHTML = `<i class="fas fa-book-open"></i> 查看${part.title}`;
        } else {
            link.href = 'javascript:void(0)';
            link.style.cursor = 'default';
            link.innerHTML = `<i class="fas fa-robot"></i> AI生成`;
        }

        partDiv.appendChild(ingList);
        partDiv.appendChild(link);
        return partDiv;
    };

        const partsWrap = document.createElement('div');
    partsWrap.className = 'combo-parts';
    partsWrap.appendChild(buildPart(main));
    partsWrap.appendChild(buildPart(side));
    info.appendChild(partsWrap);


    card.appendChild(info);
    return card;
}

    });
</script>
{% endblock %} 
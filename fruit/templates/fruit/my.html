{% load static %}
<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>个人健康档案 - 饭了么</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="{% static 'fruit/my.css' %}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* 个人信息编辑栏目样式 */
        .profile-edit-container {
            background-color: #fff;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            padding: 20px;
        }
        
        .profile-edit-header {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .profile-edit-header h3 {
            margin: 0 0 0 10px;
            font-size: 1.4rem;
            color: var(--primary-color);
        }
        
        .profile-edit-form {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }
        
        .profile-form-group {
            margin-bottom: 15px;
        }
        
        .profile-form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #555;
        }
        
        .profile-form-group input,
        .profile-form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 1rem;
        }
        
        .profile-form-actions {
            grid-column: span 2;
            display: flex;
            justify-content: flex-end;
            margin-top: 10px;
        }
        
        .profile-info-summary {
            background-color: #f9f9f9;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            grid-column: span 2;
        }
        
        .profile-info-summary h4 {
            margin-top: 0;
            color: #555;
            font-size: 1.1rem;
        }
        
        .profile-info-summary p {
            margin: 5px 0;
            font-size: 0.95rem;
        }
        
        .profile-info-summary .highlight {
            color: var(--primary-color);
            font-weight: 600;
        }
        /* 弹窗样式 */
        .modal {
            position: fixed; left: 0; top: 0; width: 100vw; height: 100vh;
            background: rgba(0,0,0,0.3); display: flex; align-items: center; justify-content: center; z-index: 9999;
        }
        .modal-content {
            background: #fff; border-radius: 10px; padding: 30px 24px; min-width: 320px; box-shadow: 0 8px 32px rgba(0,0,0,0.18);
            display: flex; flex-direction: column; align-items: stretch;
        }
        .modal-content h3 { margin-top: 0; }
        .modal-content input { margin: 16px 0 24px 0; }
        .modal-actions { display: flex; gap: 12px; justify-content: flex-end; }
    </style>
</head>
<body>
    <div class="container">
        <!-- 头部导航 -->
        <header class="header">
            <div class="nav-container">
                <div class="logo">
                    <i class="fas fa-carrot"></i> 饭了么
                </div>
                
                <div class="nav-links">
                    <a href="/recipe/">食谱</a>
                    <a href="/">商城</a>
                    <a href="/my-fridge/">冰箱</a>
                    <a href="#" style="color: var(--primary-color);">我的</a>
                    {% if user.is_authenticated %}
                    <a href="{% url 'logout_view' %}"><i class="fas fa-sign-out-alt"></i> 退出</a>
                    {% endif %}
                </div>
                
                <div class="search-container">
                    <input type="text" placeholder="搜索健康食谱...">
                    <button><i class="fas fa-search"></i></button>
                </div>
            </div>
        </header>
        
        <!-- 个人资料区域 -->
        <div class="profile-section">
            <div class="avatar-container">
                <img src="{% static 'fruit/images/user-avatar.jpg' %}" alt="用户头像">
            </div>
            
            <div class="user-info">
                <h1 class="welcome-text" id="username-display">您好，亲爱的{{ user.username }}</h1>
                <p>欢迎查看您的健康档案，今日减脂计划已准备就绪！</p>
                
                <div class="user-stats">
                    <div class="stat-item">
                        <div class="stat-value">{{ history_records|length }}</div>
                        <div class="stat-label">记录天数</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">{{ history_records.0.total_calories|default:"0" }}</div>
                        <div class="stat-label">昨日摄入</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">{{ today_record.completion_percentage|default:"0" }}%</div>
                        <div class="stat-label">今日完成度</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 个人信息编辑栏目 -->
        <div class="profile-edit-container">
            <div class="profile-edit-header">
                <i class="fas fa-user-edit fa-lg" style="color: var(--primary-color);"></i>
                <h3>个人健康信息</h3>
            </div>
            
            <form method="post" action="{% url 'my_view' %}" class="profile-edit-form">
                {% csrf_token %}
                <input type="hidden" name="update_profile" value="1">
                
                <div class="profile-form-group">
                    <label for="height">身高 (cm)</label>
                    <input type="number" id="height" name="height" value="{{ profile.height|default:'' }}" placeholder="请输入您的身高">
                </div>
                
                <div class="profile-form-group">
                    <label for="weight">体重 (kg)</label>
                    <input type="number" step="0.1" id="weight" name="weight" value="{{ profile.weight|default:'' }}" placeholder="请输入您的体重">
                </div>
                
                <div class="profile-form-group">
                    <label for="gender">性别</label>
                    <select id="gender" name="gender">
                        <option value="" {% if not profile.gender %}selected{% endif %}>请选择</option>
                        <option value="M" {% if profile.gender == 'M' %}selected{% endif %}>男</option>
                        <option value="F" {% if profile.gender == 'F' %}selected{% endif %}>女</option>
                    </select>
                </div>
                
                <div class="profile-form-group">
                    <label for="activity_level">活动等级</label>
                    <select id="activity_level" name="activity_level">
                        <option value="I" {% if profile.activity_level == 'I' %}selected{% endif %}>低活动度（久坐少动）</option>
                        <option value="II" {% if profile.activity_level == 'II' %}selected{% endif %}>中活动度（日常活动）</option>
                        <option value="III" {% if profile.activity_level == 'III' %}selected{% endif %}>高活动度（经常运动）</option>
                    </select>
                </div>
                
                <div class="profile-form-group">
                    <label for="birth_date">出生日期</label>
                    <input type="date" id="birth_date" name="birth_date" value="{{ profile.birth_date|date:'Y-m-d'|default:'' }}">
                </div>
                
                <div class="profile-form-actions">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> 保存信息
                    </button>
                </div>
                
                <div class="profile-info-summary">
                    <h4>健康信息摘要</h4>
                    <p>身高体重指数 (BMI): <span class="highlight">{{ profile.bmi|default:"未知" }}</span> 
                        {% if profile.bmi %}
                            {% if profile.bmi < 18.5 %}
                                (偏瘦)
                            {% elif profile.bmi < 24 %}
                                (正常)
                            {% elif profile.bmi < 28 %}
                                (偏胖)
                            {% else %}
                                (肥胖)
                            {% endif %}
                        {% endif %}
                    </p>
                    <p>年龄: <span class="highlight">{{ profile.age|default:"未知" }}</span> 岁</p>
                    <p>推荐每日热量摄入: <span class="highlight">{{ recommended_calories }}</span> 千卡</p>
                    <p><small>* 根据您的性别、年龄、身高、体重和活动水平计算得出</small></p>
                </div>
            </form>
        </div>
        
        <!-- 新增：热量记录表单 -->
        <div class="calorie-form-container">
            <div class="form-title">
                <i class="fas fa-utensils"></i>
                <h3 style="display:inline-block;">记录今日热量摄入</h3>
            </div>
            <!-- 热量目标展示栏，紧跟标题下方 -->
            <div class="daily-target-bar" style="display: flex; align-items: center; justify-content: flex-start; margin-bottom: 18px; gap: 12px;">
                <span>今日热量目标：<span id="daily-target-display">{{ today_record.daily_target|default:recommended_calories }}</span> 千卡</span>
                <button type="button" class="btn btn-outline btn-sm" id="edit-daily-target-btn" style="padding: 2px 10px; font-size: 0.95em; margin-left: 8px;">
                    <i class="fas fa-edit"></i>
                </button>
            </div>
            <form id="calorieForm" class="calorie-form">
                {% csrf_token %}
                <!-- 早餐部分 -->
                <div class="meal-section">
                    <div class="meal-header">
                        <i class="fas fa-sun"></i>
                        <h4>早餐</h4>
                    </div>
                    
                    <div class="form-group">
                        <label for="breakfast-food">食物名称</label>
                        <input type="text" id="breakfast-food" class="form-control" placeholder="例如：全麦面包 + 牛奶" 
                               value="{{ today_record.breakfast_food }}">
                    </div>
                    
                    <div class="form-group">
                        <label for="breakfast-calories">热量（千卡）</label>
                        <input type="number" id="breakfast-calories" class="form-control" placeholder="输入热量值"
                               value="{{ today_record.breakfast_calories }}">
                    </div>
                    
                    <div class="meal-total" id="breakfast-total">早餐总计: {{ today_record.breakfast_calories|default:"0" }} 千卡</div>
                </div>
                
                <!-- 午餐部分 -->
                <div class="meal-section">
                    <div class="meal-header">
                        <i class="fas fa-cloud-sun"></i>
                        <h4>午餐</h4>
                    </div>
                    
                    <div class="form-group">
                        <label for="lunch-food">食物名称</label>
                        <input type="text" id="lunch-food" class="form-control" placeholder="例如：番茄鸡胸肉"
                               value="{{ today_record.lunch_food }}">
                    </div>
                    
                    <div class="form-group">
                        <label for="lunch-calories">热量（千卡）</label>
                        <input type="number" id="lunch-calories" class="form-control" placeholder="输入热量值"
                               value="{{ today_record.lunch_calories }}">
                    </div>
                    
                    <div class="meal-total" id="lunch-total">午餐总计: {{ today_record.lunch_calories|default:"0" }} 千卡</div>
                </div>
                
                <!-- 晚餐部分 -->
                <div class="meal-section">
                    <div class="meal-header">
                        <i class="fas fa-moon"></i>
                        <h4>晚餐</h4>
                    </div>
                    
                    <div class="form-group">
                        <label for="dinner-food">食物名称</label>
                        <input type="text" id="dinner-food" class="form-control" placeholder="例如：蔬菜沙拉"
                               value="{{ today_record.dinner_food }}">
                    </div>
                    
                    <div class="form-group">
                        <label for="dinner-calories">热量（千卡）</label>
                        <input type="number" id="dinner-calories" class="form-control" placeholder="输入热量值"
                               value="{{ today_record.dinner_calories }}">
                    </div>
                    
                    <div class="meal-total" id="dinner-total">晚餐总计: {{ today_record.dinner_calories|default:"0" }} 千卡</div>
                </div>
            </form>
            
            <div class="daily-total">
                今日总摄入: <span id="daily-total-calories">{{ today_record.total_calories|default:"0" }}</span> 千卡
            </div>
            
            <div class="form-actions">
                <button type="button" class="btn btn-outline" id="reset-form">
                    <i class="fas fa-redo"></i> 重置
                </button>
                <button type="button" class="btn btn-primary" id="save-calories">
                    <i class="fas fa-save"></i> 保存记录
                </button>
            </div>
        </div>
        
        <!-- 热量卡片 -->
        <div class="calorie-card">
            <div class="card-header">
                <h2 class="card-title"><i class="fas fa-fire"></i> 今日能量摄入统计</h2>
                <div class="card-date">{{ today_date }}</div>
            </div>
            
            <div class="calorie-content">
                <div class="calorie-goal">
                    <h3>每日热量目标：<strong>{{ today_record.daily_target|default:"1500" }} 千卡</strong></h3>
                    <div class="goal-progress">
                        <div class="progress-bar" style="width: {{ today_record.completion_percentage|default:"0" }}%"></div>
                        <div class="progress-text">{{ today_record.total_calories|default:"0" }}/{{ today_record.daily_target|default:"1500" }} 千卡</div>
                    </div>
                    
                    <div class="calorie-details">
                        <div class="detail-item">
                            <div class="detail-value">{{ today_record.total_calories|default:"0" }}</div>
                            <div class="detail-label">已摄入</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-value remaining">{{ today_record.remaining_calories|default:"1500" }}</div>
                            <div class="detail-label">剩余可摄入</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-value">{{ today_record.completion_percentage|default:"0" }}%</div>
                            <div class="detail-label">完成度</div>
                        </div>
                    </div>
                </div>
                
                <div class="calorie-recommend">
                    <h3 class="recommend-title"><i class="fas fa-lightbulb"></i> 晚餐建议</h3>
                    <ul class="recommend-list">
                        {% if today_record and today_record.remaining_calories > 0 %}
                            <li>今日剩余可摄入 <strong>{{ today_record.remaining_calories }}</strong> 千卡</li>
                            <li>晚餐推荐选择热量≤{{ today_record.remaining_calories|default:"500" }}千卡的菜品</li>
                            <li>推荐：蔬菜沙拉配鸡胸肉（约350千卡）</li>
                            <li>可选：番茄鸡蛋汤（约200千卡）</li>
                            <li>避免：油炸食品、高糖食物</li>
                        {% elif today_record and today_record.remaining_calories <= 0 %}
                            <li class="exceeded">今日已超标 <strong>{{ today_record.remaining_calories|cut:"-" }}</strong> 千卡</li>
                            <li>建议增加运动消耗多余热量</li>
                            <li>晚餐推荐低热量食物：蔬菜汤（约150千卡）</li>
                            <li>明天注意控制热量摄入</li>
                        {% else %}
                            <li>选择热量≤500千卡的菜品</li>
                            <li>推荐：蔬菜沙拉配鸡胸肉（约350千卡）</li>
                            <li>可选：番茄鸡蛋汤（约200千卡）</li>
                            <li>避免：油炸食品、高糖食物</li>
                        {% endif %}
                    </ul>
                </div>
            </div>
        </div>
        
        <!-- 图表区域 -->
        <div class="chart-container">
            <div class="chart-header">
                <h2 class="card-title"><i class="fas fa-chart-line"></i> 周度热量趋势</h2>
                <div class="chart-actions">
                    <button class="time-btn active" data-period="week">本周</button>
                    <button class="time-btn" data-period="last-week">上周</button>
                    <button class="time-btn" data-period="month">本月</button>
                </div>
            </div>
            
            <div class="chart-wrapper">
                <canvas id="calorie-chart"></canvas>
                <div class="chart-loading" style="display: none;">
                    <i class="fas fa-spinner fa-spin"></i> 加载中...
                </div>
            </div>
        </div>
        
        <!-- 新增：历史记录区域 -->
        <div class="history-container">
            <div class="history-header">
                <h3 class="history-title"><i class="fas fa-history"></i> 历史记录</h3>
                <div>
                    <button class="btn btn-outline">
                        <i class="fas fa-calendar-alt"></i> 选择日期
                    </button>
                </div>
            </div>
            
            <table class="history-table">
                <thead>
                    <tr>
                        <th>日期</th>
                        <th>早餐</th>
                        <th>午餐</th>
                        <th>晚餐</th>
                        <th>总热量</th>
                        <th>状态</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody>
                    {% for record in history_records %}
                    <tr>
                        <td>{{ record.date|date:"m月d日" }}</td>
                        <td>{{ record.breakfast_food }} ({{ record.breakfast_calories }}千卡)</td>
                        <td>{{ record.lunch_food }} ({{ record.lunch_calories }}千卡)</td>
                        <td>{{ record.dinner_food }} ({{ record.dinner_calories }}千卡)</td>
                        <td>{{ record.total_calories }}千卡</td>
                        <td class="status-cell">
                            <div class="status-badge status-{{ record.status }}"></div>
                            <span>
                                {% if record.status == 'exceed' %}
                                    已超标
                                {% elif record.status == 'warning' %}
                                    接近上限
                                {% else %}
                                    达标
                                {% endif %}
                            </span>
                        </td>
                        <td>
                            <a href="{% url 'edit_calorie_record' record.id %}" class="edit-btn">
                                <i class="fas fa-edit"></i> 编辑
                            </a>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="7" class="empty-message">暂无历史记录，开始记录您的第一餐吧！</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        <!-- 页脚 -->
        <footer class="footer">
            <div class="footer-content">
                <div class="footer-column">
                    <h3>关于我们</h3>
                    <ul class="footer-links">
                        <li><a href="#">公司简介</a></li>
                        <li><a href="#">品牌故事</a></li>
                        <li><a href="#">团队介绍</a></li>
                        <li><a href="#">招贤纳士</a></li>
                    </ul>
                </div>
                
                <div class="footer-column">
                    <h3>客户服务</h3>
                    <ul class="footer-links">
                        <li><a href="#">帮助中心</a></li>
                        <li><a href="#">售后服务</a></li>
                        <li><a href="#">配送说明</a></li>
                        <li><a href="#">退换政策</a></li>
                    </ul>
                </div>
                
                <div class="footer-column">
                    <h3>商务合作</h3>
                    <ul class="footer-links">
                        <li><a href="#">供应商入驻</a></li>
                        <li><a href="#">广告合作</a></li>
                        <li><a href="#">渠道合作</a></li>
                        <li><a href="#">企业采购</a></li>
                    </ul>
                </div>
                
                <div class="footer-column">
                    <h3>关注我们</h3>
                    <ul class="footer-links">
                        <li><a href="#"><i class="fab fa-weixin"></i> 微信公众号</a></li>
                        <li><a href="#"><i class="fab fa-weibo"></i> 新浪微博</a></li>
                        <li><a href="#"><i class="fab fa-tiktok"></i> 抖音</a></li>
                        <li><a href="#"><i class="fab fa-instagram"></i> Instagram</a></li>
                    </ul>
                </div>
            </div>
            
            <div class="copyright">
                <p>&copy; 2025 饭了么 - 健康食材商城 | 让新鲜食材直达您的厨房</p>
            </div>
        </footer>
    </div>
    
    <!-- 悬浮购物车按钮 -->
    <a href="/cart/" class="floating-cart" title="查看购物车">
        <i class="fas fa-shopping-cart"></i>
    </a>
    
    <!-- 弹窗HTML，放在页面底部 -->
    <div id="daily-target-modal" class="modal" style="display:none;">
        <div class="modal-content">
            <h3>编辑每日热量目标</h3>
            <input type="number" id="modal-daily-target-input"
                   class="form-control"
                   placeholder="{{ recommended_calories }}"
                   value="{{ today_record.daily_target|default:recommended_calories }}">
            <div class="modal-actions">
                <button type="button" class="btn btn-outline" id="cancel-daily-target">取消</button>
                <button type="button" class="btn btn-outline" id="default-daily-target">使用推荐值</button>
                <button type="button" class="btn btn-primary" id="save-daily-target">保存</button>
            </div>
        </div>
    </div>

    <!-- Font Awesome 图标库 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
    
    <script>
        // 新增：热量记录功能
        document.addEventListener('DOMContentLoaded', function() {
            // 获取表单元素
            const breakfastCalories = document.getElementById('breakfast-calories');
            const lunchCalories = document.getElementById('lunch-calories');
            const dinnerCalories = document.getElementById('dinner-calories');
            const dailyTotal = document.getElementById('daily-total-calories');
            const saveButton = document.getElementById('save-calories');
            const resetButton = document.getElementById('reset-form');
            
            // 初始化总热量
            updateTotalCalories();
            
            // 为每个热量输入框添加事件监听器
            breakfastCalories.addEventListener('input', updateTotalCalories);
            lunchCalories.addEventListener('input', updateTotalCalories);
            dinnerCalories.addEventListener('input', updateTotalCalories);
            
            // 保存按钮事件
            saveButton.addEventListener('click', function() {
                const breakfastFood = document.getElementById('breakfast-food').value;
                const breakfast = parseInt(breakfastCalories.value) || 0;
                const lunchFood = document.getElementById('lunch-food').value;
                const lunch = parseInt(lunchCalories.value) || 0;
                const dinnerFood = document.getElementById('dinner-food').value;
                const dinner = parseInt(dinnerCalories.value) || 0;
                // 使用AJAX发送数据到后端
                fetch('/my/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: JSON.stringify({
                        breakfast_food: breakfastFood,
                        breakfast_calories: breakfast,
                        lunch_food: lunchFood,
                        lunch_calories: lunch,
                        dinner_food: dinnerFood,
                        dinner_calories: dinner
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // 更新卡片显示
                        const total = data.total;
                        const remaining = data.remaining;
                        const percentage = data.percentage;
                        document.querySelector('.progress-bar').style.width = `${percentage}%`;
                        document.querySelector('.progress-text').textContent = `${total}/{{ today_record.daily_target|default:"1500" }} 千卡`;
                        document.querySelector('.detail-value').textContent = total;
                        document.querySelector('.detail-value.remaining').textContent = remaining;
                        document.querySelector('.calorie-details .detail-item:nth-child(3) .detail-value').textContent = `${percentage}%`;
                        // 更新建议
                        const recommendList = document.querySelector('.recommend-list');
                        if (remaining > 0) {
                            recommendList.innerHTML = `
                                <li>今日剩余可摄入 <strong>${remaining}</strong> 千卡</li>
                                <li>晚餐推荐选择热量≤${Math.min(remaining, 500)}千卡的菜品</li>
                                <li>推荐：蔬菜沙拉配鸡胸肉（约350千卡）</li>
                                <li>可选：番茄鸡蛋汤（约200千卡）</li>
                                <li>避免：油炸食品、高糖食物</li>
                            `;
                        } else {
                            recommendList.innerHTML = `
                                <li class="exceeded">今日已超标 <strong>${Math.abs(remaining)}</strong> 千卡</li>
                                <li>建议增加运动消耗多余热量</li>
                                <li>晚餐推荐低热量食物：蔬菜汤（约150千卡）</li>
                                <li>明天注意控制热量摄入</li>
                            `;
                        }
                        // 显示成功消息
                        alert('热量记录已保存！');
                        // 刷新页面以更新历史记录
                        setTimeout(() => {
                            window.location.reload();
                        }, 1000);
                    }
                })
                .catch(error => {
                    console.error('保存失败:', error);
                    alert('保存失败，请重试！');
                });
            });
            
            // 重置按钮事件
            resetButton.addEventListener('click', function() {
                document.getElementById('breakfast-food').value = '';
                document.getElementById('breakfast-calories').value = '';
                document.getElementById('lunch-food').value = '';
                document.getElementById('lunch-calories').value = '';
                document.getElementById('dinner-food').value = '';
                document.getElementById('dinner-calories').value = '';
                updateTotalCalories();
            });
            
            // 更新总热量函数
            function updateTotalCalories() {
                const breakfast = parseInt(breakfastCalories.value) || 0;
                const lunch = parseInt(lunchCalories.value) || 0;
                const dinner = parseInt(dinnerCalories.value) || 0;
                const total = breakfast + lunch + dinner;
                
                // 更新显示
                document.getElementById('breakfast-total').textContent = `早餐总计: ${breakfast} 千卡`;
                document.getElementById('lunch-total').textContent = `午餐总计: ${lunch} 千卡`;
                document.getElementById('dinner-total').textContent = `晚餐总计: ${dinner} 千卡`;
                dailyTotal.textContent = total;
            }
        });
        
        // 图表数据
        const chartData = {{ chart_data|safe }};

        let calorieChart = null;

        // 初始化热量图表
        function initCalorieChart(period = 'week') {
            const ctx = document.getElementById('calorie-chart').getContext('2d');
            const data = chartData[period];
            
            if (calorieChart) {
                calorieChart.destroy();
            }
            
            calorieChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.labels,
                    datasets: [
                        {
                            label: '目标热量',
                            data: data.labels.map(() => 1500),
                            backgroundColor: 'rgba(78, 205, 196, 0.2)',
                            borderColor: 'rgba(78, 205, 196, 1)',
                            borderWidth: 1,
                            type: 'line',
                            fill: false,
                            pointRadius: 4,
                            pointBackgroundColor: 'rgba(78, 205, 196, 1)'
                        },
                        {
                            label: '实际摄入',
                            data: data.data,
                            backgroundColor: data.data.map(value => 
                                value > 1500 ? 'rgba(231, 76, 60, 0.7)' : 'rgba(46, 204, 113, 0.7)'),
                            borderColor: data.data.map(value => 
                                value > 1500 ? 'rgba(231, 76, 60, 1)' : 'rgba(46, 204, 113, 1)'),
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: false,
                            min: Math.min(...data.data, 1000) - 200,
                            max: Math.max(...data.data, 2000) + 200,
                            title: {
                                display: true,
                                text: '热量 (千卡)'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.dataset.label}: ${context.raw} 千卡`;
                                },
                                afterLabel: function(context) {
                                    if (context.datasetIndex === 1) {
                                        const target = 1500;
                                        const diff = context.raw - target;
                                        if (diff > 0) {
                                            return `超量: +${diff} 千卡`;
                                        } else if (diff < 0) {
                                            return `剩余: ${-diff} 千卡`;
                                        }
                                        return '刚好达标';
                                    }
                                }
                            }
                        }
                    }
                }
            });
        }

        // 设置用户名
        document.addEventListener('DOMContentLoaded', function() {
            // 初始化图表
            initCalorieChart();
            
            // 时间按钮切换
            const timeBtns = document.querySelectorAll('.time-btn');
            
            timeBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    // 切换按钮状态
                    timeBtns.forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    
                    // 立即更新图表
                    const period = this.dataset.period;
                    initCalorieChart(period);
                });
            });
        });

        // 弹窗相关
        const modal = document.getElementById('daily-target-modal');
        const modalInput = document.getElementById('modal-daily-target-input');
        const editBtn = document.getElementById('edit-daily-target-btn');
        const cancelBtn = document.getElementById('cancel-daily-target');
        const defaultBtn = document.getElementById('default-daily-target');
        const saveBtn = document.getElementById('save-daily-target');
        const dailyTargetDisplay = document.getElementById('daily-target-display');
        const recommended = parseInt(modalInput.placeholder);

        // 打开弹窗
        editBtn.addEventListener('click', function() {
            modalInput.value = dailyTargetDisplay.textContent.trim();
            modal.style.display = 'flex';
        });
        // 取消
        cancelBtn.addEventListener('click', function() {
            modal.style.display = 'none';
        });
        // 使用推荐值
        defaultBtn.addEventListener('click', function() {
            modalInput.value = recommended;
        });
        // 保存
        saveBtn.addEventListener('click', function() {
            const newTarget = parseInt(modalInput.value) || recommended;
            fetch('/my/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: JSON.stringify({
                    daily_target: newTarget
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    dailyTargetDisplay.textContent = newTarget;
                    modal.style.display = 'none';
                    window.location.reload();
                }
            });
        });
        // 点击遮罩关闭
        modal.addEventListener('click', function(e) {
            if (e.target === modal) modal.style.display = 'none';
        });
    </script>
</body>
</html> 